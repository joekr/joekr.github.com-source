<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Bitbucket on Joe Kratzat</title>
    <link>http://joekratzat.com/categories/bitbucket/</link>
    <description>Recent content in Bitbucket on Joe Kratzat</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <lastBuildDate>Tue, 21 May 2013 22:11:00 -0500</lastBuildDate>
    <atom:link href="http://joekratzat.com/categories/bitbucket/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>jenkins and bitbucket</title>
      <link>http://joekratzat.com/blog/2013/jenkins-and-bitbucket/</link>
      <pubDate>Tue, 21 May 2013 22:11:00 -0500</pubDate>
      
      <guid>http://joekratzat.com/blog/2013/jenkins-and-bitbucket/</guid>
      <description>

&lt;p&gt;Tonight I had to setup a new instance of Jenkins. Having never set  Jenkins to work with Bitbucket before I thought this might help out others. This will cover Jenkins accessing only Bitbucket, having it deploy might be another post, but that isn&amp;rsquo;t covered here.&lt;/p&gt;

&lt;h2 id=&#34;jenkins-install&#34;&gt;Jenkins install&lt;/h2&gt;

&lt;p&gt;Starting out, I have a blank &lt;a href=&#34;https://www.digitalocean.com/&#34;&gt;Digital Ocean&lt;/a&gt; droplet. There is basically nothing. I had to install Jenkins, which is pretty basic:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;wget -q -O - &lt;a href=&#34;http://pkg.jenkins-ci.org/debian/jenkins-ci.org.key&#34;&gt;http://pkg.jenkins-ci.org/debian/jenkins-ci.org.key&lt;/a&gt; | sudo apt-key add -&lt;/p&gt;

&lt;p&gt;sudo sh -c &amp;lsquo;echo deb &lt;a href=&#34;http://pkg.jenkins-ci.org/debian&#34;&gt;http://pkg.jenkins-ci.org/debian&lt;/a&gt; binary/ &amp;gt; /etc/apt/sources.list.d/jenkins.list&amp;rsquo;&lt;/p&gt;

&lt;p&gt;sudo apt-get update&lt;/p&gt;

&lt;p&gt;sudo apt-get install jenkins&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This will create the jenkins user and start up the Jenkins servlet on port 8080. If you need to setup Jenkins other ways checkout the &lt;a href=&#34;https://wiki.jenkins-ci.org/display/JENKINS/Installing+Jenkins+on+Ubuntu&#34;&gt;How-to&lt;/a&gt;.&lt;/p&gt;

&lt;!-- more --&gt;

&lt;h2 id=&#34;jenkins-unix-security-setup&#34;&gt;Jenkins Unix/security setup&lt;/h2&gt;

&lt;p&gt;Next I needed to setup Jenkins to use my unix user permissions. The security settings can be accessed by going to: &lt;a href=&#34;http://your_server:8080/configureSecurity/&#34;&gt;http://your_server:8080/configureSecurity/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;From the configureSecurity page select &amp;ldquo;&lt;strong&gt;Unix user/group database&lt;/strong&gt;&amp;ldquo;
click on &amp;ldquo;&lt;strong&gt;Advanced&lt;/strong&gt;&amp;rdquo; and add &amp;ldquo;&lt;strong&gt;sshd&lt;/strong&gt;&amp;rdquo; as the Service Name. While setting this up I got on error saying the jenkins user could read from &amp;ldquo;&lt;strong&gt;/etc/shadow/&lt;/strong&gt;&amp;rdquo;. So I had to add the jenkins user to the shadow group.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;usermod -G shadow jenkins&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Lastly to setup permissions I selected: &amp;ldquo;Logged-in users can do anything&amp;rdquo;.&lt;/p&gt;

&lt;h2 id=&#34;git-setup&#34;&gt;Git setup&lt;/h2&gt;

&lt;p&gt;Since this was a basic ubuntu install I had to install git:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;sudo apt-get install git&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Then setup the git user information:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;git config &amp;ndash;global user.email &amp;ldquo;example@email.com&amp;rdquo;&lt;/p&gt;

&lt;p&gt;git config &amp;ndash;global user.name &amp;ldquo;jenkins&amp;rdquo;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Not having the user info set resulted in Jenkins later through throwing: &lt;strong&gt;hudson.plugins.git.GitException: Could not apply tag jenkins-Pactsafe_-_TEST-2&lt;/strong&gt; when trying to run a build. Better set them now. I used the global config because this droplet will only be used for Jenkins.&lt;/p&gt;

&lt;p&gt;Next install the git plug in for Jenkins. Using the Jenkins menu go to:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Manage Jenkins&lt;/li&gt;
&lt;li&gt;Manage Plugins&lt;/li&gt;
&lt;li&gt;Available&lt;/li&gt;
&lt;li&gt;Then search for &amp;ldquo;Git Plugin&amp;rdquo;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Once Jenkins restarts you can move on to setup a new job.&lt;/p&gt;

&lt;h2 id=&#34;new-job-with-ssh-and-bitbucket&#34;&gt;New Job with SSH and Bitbucket&lt;/h2&gt;

&lt;p&gt;Finally, setting up Jenkins to simply access a repo from Bitbucket! They have a nice write up on this: &lt;a href=&#34;https://confluence.atlassian.com/display/BITBUCKET/Using+the+SSH+protocol+with+bitbucket#UsingtheSSHprotocolwithBitbucket-RepositoryURLformatsbyconnectionprotocol&#34;&gt;SSH with Bitbucket&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Since Digital Ocean allows for shell access I was able to generate an ssh key for my jenkins user. I logged in as jenkins and ran &lt;strong&gt;ssh-keygen&lt;/strong&gt;. ssh-keygen will (by default) generate the public key in ~/.ssh/id_rsa.pub. For more information checkout &lt;a href=&#34;https://confluence.atlassian.com/pages/viewpage.action?pageId=270827678&#34;&gt;Bitbucket&amp;rsquo;s How-to&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Open Bitbucket and go to the repository you want Jenkins to access. As Admin, access the repository&amp;rsquo;s settings and setup a new &lt;a href=&#34;http://blog.bitbucket.org/2012/06/20/deployment-keys/&#34;&gt;deployment key&lt;/a&gt; using the previously generated contents from the id_rsa.pub file.&lt;/p&gt;

&lt;p&gt;You will also need to setup a ~/.ssh/known_hosts file. If you don&amp;rsquo;t the build will fail with this error &lt;strong&gt;stderr: Host key verification failed.&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;The easiest way to create the known_host file is to run (as jenkins):&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;git ls-remote -h git@bitbucket.org:person/projectmarket.git HEAD&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Doing this will prompt you to add Bitbucket as a known host. Once you confirm the host the key for bitbucket.org it will be added to the ~/.ssh/known_hosts file and you shouldn&amp;rsquo;t get this error anymore.&lt;/p&gt;

&lt;h2 id=&#34;run-the-job&#34;&gt;Run The Job&lt;/h2&gt;

&lt;p&gt;With all of that setup you should be able to run the job and receive a &amp;ldquo;Finished: SUCCESS&amp;rdquo; message in the Console Output.&lt;/p&gt;

&lt;p&gt;There are many things that still need to be setup after this, but this gets Jenkins and Bitbucket playing together.&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>